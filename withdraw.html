<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø³Ø­Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        background: #0d0d0d;
        color: white;
        font-family: system-ui;
        text-align: center;
        padding: 20px;
    }

    h2 {
        color: gold;
        margin-bottom: 20px;
    }

    .box {
        background: #1d1d1d;
        padding: 20px;
        border-radius: 15px;
        border: 1px solid #444;
        margin-bottom: 20px;
    }

    input {
        width: 100%;
        padding: 12px;
        margin-top: 12px;
        background: #111;
        border: 1px solid #555;
        border-radius: 10px;
        color: white;
        font-size: 16px;
        text-align: right;
    }

    button {
        width: 100%;
        padding: 12px;
        margin-top: 15px;
        background: gold;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        color: black;
        cursor: pointer;
    }

    .note {
        color: #bbb;
        font-size: 13px;
        margin-top: 10px;
    }

</style>
</head>

<body>

<h2>Ø³Ø­Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„</h2>

<div class="box">

    <input id="amount" type="number" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨">
    <input id="wallet" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© USDT (TRC20)">

    <button onclick="submitWithdraw()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>

    <div class="note">
        âš  Ø§Ù„Ø³Ø­Ø¨ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ù…Ø±ÙˆØ± <b>25 ÙŠÙˆÙ…</b> Ù…Ù† Ø£ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø­Ù†
    </div>

</div>

<script type="module">

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
    "https://zrnrrnbyhjcusfwoeucd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

let user_id = null;
let balance = 0;
let firstDepositDate = null;

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function loadData() {
    let { data: session } = await supabase.auth.getUser();

    if (!session.user) {
        window.location.href = "index.html";
        return;
    }

    user_id = session.user.id;

    let { data: bal } = await supabase
        .from("balances")
        .select("*")
        .eq("user_id", user_id)
        .maybeSingle();

    balance = bal?.balance ?? 0;
    firstDepositDate = bal?.first_deposit_date ?? null;
}

loadData();

// Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨
async function submitWithdraw() {

    let amount = parseFloat(document.getElementById("amount").value);
    let wallet = document.getElementById("wallet").value.trim();

    if (!amount || amount <= 0) {
        alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
        return;
    }

    if (amount > balance) {
        alert("ğŸš« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø£ÙƒØ¨Ø± Ù…Ù† Ø±ØµÙŠØ¯Ùƒ");
        return;
    }

    if (!wallet) {
        alert("Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© TRC20");
        return;
    }

    if (!firstDepositDate) {
        alert("ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø³Ø­Ø¨ Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø£ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø­Ù†");
        return;
    }

    let start = new Date(firstDepositDate);
    let now = new Date();
    let diff = (now - start) / (1000 * 60 * 60 * 24);

    if (diff < 25) {
        alert("ğŸš« Ø§Ù„Ø³Ø­Ø¨ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù‚Ø¨Ù„ Ù…Ø±ÙˆØ± 25 ÙŠÙˆÙ…\nØ¨Ø§Ù‚ÙŠ: " + Math.ceil(25 - diff) + " ÙŠÙˆÙ…");
        return;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    let { error } = await supabase.from("withdrawal_requests").insert({
        user_id: user_id,
        amount: amount,
        wallet_address: wallet,
        status: "pending",
        created_at: new Date()
    });

    if (error) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
        return;
    }

    alert("âœ” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©");
    window.location.href = "wallet.html";
}

</script>

</body>
</html>
